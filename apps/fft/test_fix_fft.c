
/*
  Short test program to accompany fix_fft.c
*/

#define DEBUG 1
#define SPECTRUM 0
/*
#include <stdio.h>
#include <stdlib.h>
#include <math.h>
*/

#include "fix_fft.h"

short cosine[] PROGMEM = {
 12288,	12195,	11919,	11464,	10837,	10046,	9104,	8026,
 6826,	5524,	4139,	2692,	1204,	-301,	-1803,	-3277,
 -4702,	-6056,	-7319,	-8473,	-9498,	-10381,	-11108,	-11667,
 -12051,	-12254,	-12273,	-12107,	-11758,	-11233,	-10539,	-9687,
 -8688,	-7559,	-6317,	-4979,	-3567,	-2100,	-602,	903,
 2397,	3854,	5253,	6574,	7795,	8899,	9869,	10691,
 11352,	11842,	12155,	12284,	12228,	11989,	11569,	10975,
 10217,	9304,	8252,	7075,	5792,	4422,	2985,	1504,
 0,	-1504,	-2985,	-4422,	-5792,	-7075,	-8252,	-9304,
 -10217,	-10975,	-11569,	-11989,	-12228,	-12284,	-12155,	-11842,
 -11352,	-10691,	-9869,	-8899,	-7795,	-6574,	-5253,	-3854,
 -2397,	-903,	602,	2100,	3567,	4979,	6317,	7559,
 8688,	9687,	10539,	11233,	11758,	12107,	12273,	12254,
 12051,	11667,	11108,	10381,	9498,	8473,	7319,	6056,
 4702,	3277,	1803,	301,	-1204,	-2692,	-4139,	-5524,
 -6826,	-8026,	-9104,	-10046,	-10837,	-11464,	-11919,	-12195,
 -12288,	-12195,	-11919,	-11464,	-10837,	-10046,	-9104,	-8026,
 -6826,	-5524,	-4139,	-2692,	-1204,	301,	1803,	3277,
 4702,	6056,	7319,	8473,	9498,	10381,	11108,	11667,
 12051,	12254,	12273,	12107,	11758,	11233,	10539,	9687,
 8688,	7559,	6317,	4979,	3567,	2100,	602,	-903,
 -2397,	-3854,	-5253,	-6574,	-7795,	-8899,	-9869,	-10691,
 -11352,	-11842,	-12155,	-12284,	-12228,	-11989,	-11569,	-10975,
 -10217,	-9304,	-8252,	-7075,	-5792,	-4422,	-2985,	-1504,
 0,	1504,	2985,	4422,	5792,	7075,	8252,	9304,
 10217,	10975,	11569,	11989,	12228,	12284,	12155,	11842,
 11352,	10691,	9869,	8899,	7795,	6574,	5253,	3854,
 2397,	903,	-602,	-2100,	-3567,	-4979,	-6317,	-7559,
 -8688,	-9687,	-10539,	-11233,	-11758,	-12107,	-12273,	-12254,
 -12051,	-11667,	-11108,	-10381,	-9498,	-8473,	-7319,	-6056,
 -4702,	-3277,	-1803,	-301,	1204,	2692,	4139,	5524,
 6826,	8026,	9104,	10046,	10837,	11464,	11919,	12195
};

int absolute(int number) {
  if (number < 0)
    return (0 - number);
  else 
    return number;  
}

int main(){
  // Initializing the Safe Stack Pointer
  SSPL = 0x68;
  SSPH = 0x09;

  // Initialize memory
  mem_init();

  dom0_main();
  while(1);
  return 0;
}

int dom0_realmain()
{
  int i, scale;
  unsigned* diff;
  short *x, *fx;
  x = mmc_malloc(sizeof(short) * N);
  fx = mmc_malloc(sizeof(short) * N);
  diff = mmc_malloc(sizeof(unsigned));

  DDRA = 0xFF;
  PORTA = 0x00;

  for (i=0; i<N; i++){
    x[i] = pgm_read_word_near((short*)&cosine[i]);
    if (i & 0x01)
      fx[(N+i)>>1] = x[i];
    else
      fx[i>>1] = x[i];
  }

  PORTA = 0x01;

  mmc_change_own((void*)fx, 1);
  fix_fftr(fx, log2N, 0);

  PORTA = 0x02;

  scale = fix_fftr(fx, log2N, 1);

  PORTA = 0x03;

  for (i=0,*diff=0; i<N; i++) {
    int sample;
    if (i & 0x01)
      sample = fx[(N+i)>>1] << scale;
    else
      sample = fx[i>>1] << scale;
    *diff += absolute(x[i]-sample);
  }

  PORTA = 0x04;

  PORTA = (uint8_t)(*diff);
  PORTA = (uint8_t)(*diff >> 8);
  // The result here is believed to be 0x8EBE

  PORTA = 0x05;

  while(1);

  return 0;
}

